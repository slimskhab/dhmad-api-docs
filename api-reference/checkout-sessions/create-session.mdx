---
title: Create Checkout Session
description: Create a checkout session for critical escrow actions
---

<Endpoint method="POST" path="/api/v1/escrows/:id/sessions" />

Create a checkout session for a critical escrow action. The session allows you to redirect a specific user to dhmad.tn to perform the action (e.g., sign contract, accept & pay, complete, dispute, or handle cancellation). The user is redirected back to your `redirectUrl` after completing or abandoning the flow.

<Warning>
  Configure allowed redirect URLs in your [Developer Dashboard](https://developer.dhmad.tn/dashboard) settings before creating checkout sessions. If no redirect URLs are configured, or if the `redirectUrl` does not match any allowed URL, the request will fail with a 400 error.
</Warning>

<RequestExample>
```bash cURL
curl -X POST https://dhmad.tn/api/v1/escrows/507f1f77bcf86cd799439011/sessions \
  -H "Authorization: Bearer sk_live_your_api_key_here" \
  -H "Content-Type: application/json" \
  -d '{
    "action": "sign_contract",
    "targetUserEmail": "buyer@example.com",
    "redirectUrl": "https://myapp.com/checkout/callback",
    "metadata": {
      "order_id": "ord_123"
    }
  }'
```

```javascript JavaScript
const response = await fetch('https://dhmad.tn/api/v1/escrows/507f1f77bcf86cd799439011/sessions', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer sk_live_your_api_key_here',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    action: 'sign_contract',
    targetUserEmail: 'buyer@example.com',
    redirectUrl: 'https://myapp.com/checkout/callback',
    metadata: { order_id: 'ord_123' }
  })
});

const data = await response.json();
```

```python Python
import requests

response = requests.post(
    'https://dhmad.tn/api/v1/escrows/507f1f77bcf86cd799439011/sessions',
    headers={
        'Authorization': 'Bearer sk_live_your_api_key_here',
        'Content-Type': 'application/json'
    },
    json={
        'action': 'sign_contract',
        'targetUserEmail': 'buyer@example.com',
        'redirectUrl': 'https://myapp.com/checkout/callback',
        'metadata': {'order_id': 'ord_123'}
    }
)

data = response.json()
```
</RequestExample>

<ResponseExample>
```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "url": "https://dhmad.tn/checkout/550e8400-e29b-41d4-a716-446655440000",
  "expiresAt": "2024-01-15T10:30:00Z"
}
```
</ResponseExample>

## Path Parameters

<ParamField path="id" type="string" required>
  Escrow ID
</ParamField>

## Request Body

<ParamField body="action" type="string" required>
  The action the user will perform. Must be one of: `sign_contract`, `accept_pay`, `complete`, `dispute`, `request_cancellation`, `reject_cancellation`, `accept_cancellation`.
</ParamField>

<ParamField body="targetUserEmail" type="string" required>
  Email of the user who will perform the action. Only this user can complete the session.
</ParamField>

<ParamField body="redirectUrl" type="string" required>
  URL to redirect the user after they complete or abandon the flow. Must match one of your allowed redirect URLs configured in the developer dashboard. Must use HTTPS (except `http://localhost` for development).
</ParamField>

<ParamField body="metadata" type="object" required={false}>
  Optional key-value pairs (strings only). Useful for tracking orders or internal references. Values must be 500 characters or less.
</ParamField>

## Response Fields

<ParamField response="sessionId" type="string">
  Unique session identifier. Use this to construct the checkout URL or to query session status.
</ParamField>

<ParamField response="url" type="string">
  Full URL to redirect the user to: `https://dhmad.tn/checkout/:sessionId` (or sandbox URL for sandbox mode).
</ParamField>

<ParamField response="expiresAt" type="string">
  ISO 8601 timestamp when the session expires. Sessions expire 30 minutes after creation.
</ParamField>

## Error Responses

### 400 Bad Request

**No Redirect URLs Configured**

```json
{
  "error": "Bad Request",
  "message": "No allowed redirect URLs configured. Please add redirect URLs in the developer dashboard settings."
}
```

**Redirect URL Mismatch**

```json
{
  "error": "Bad Request",
  "message": "Redirect URL does not match any allowed redirect URLs. Allowed: https://myapp.com/callback, https://myapp.com/checkout/callback"
}
```

**Not HTTPS**

```json
{
  "error": "Bad Request",
  "message": "Redirect URL must use HTTPS (http://localhost is allowed for development)."
}
```

**Invalid Action**

```json
{
  "error": "Bad Request",
  "message": "Invalid action. Must be one of: sign_contract, accept_pay, complete, dispute, request_cancellation, reject_cancellation, accept_cancellation"
}
```

### 401 Unauthorized

```json
{
  "error": "Unauthorized"
}
```

### 403 Forbidden

```json
{
  "error": "Forbidden",
  "message": "You do not have access to this escrow."
}
```

### 404 Not Found

**Escrow Not Found**

```json
{
  "error": "Escrow not found"
}
```

**Developer Not Found**

```json
{
  "error": "Developer not found"
}
```

---

<Note>
  Sessions expire 30 minutes after creation. Ensure users complete the flow within this window, or create a new session if needed.
</Note>
